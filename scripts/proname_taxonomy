#!/bin/bash

echo -ne "\n**************************************************************************************************************\n"
echo -ne "* You are executing the \033[1mproname_taxonomy\033[0m script, which is the fourth and last part of the \033[1mPRONAME\033[0m pipeline.  *\n"
echo -ne "*                                                                                                            *\n"
echo -ne "* Please \033[31m\033[1mdo not\033[0m move, rename or remove files and folders generated by PRONAME until the end of the pipeline. *\n"
echo -ne "**************************************************************************************************************\n\n"

# Help menu

Help()
{

## Display Help
   echo -ne "\nThe proname_taxonomy script is the fourth and last part of the PRONAME pipeline. This script carries out the taxonomic analysis of \nHQ consensus sequences coming from the proname_refine script. QIIME2-formatted taxonomy and barplot files are generated if the QIIME2 \noption was selected at the previous step (proname_refine). If not, the taxonomic analysis provides a taxonomy TSV file that can be used \nfor any other application outside of QIIME2. A phyloseq object can also be generated for further analyses using R."
   echo
   echo -ne "\nSyntax: proname_taxonomy [--qseqs|--qtable|--db|--reftax|--evalue|--percid|--qcover|--threads|--metadata|--assay|--phyloseq|--version|--verbose|--help]"
   echo
   echo "Options:"
   echo -ne "\t--qseqs\t\tPath to query sequences. It should be either 'rep_seqs.qza' (if data was imported into QIIME2 at the \n"
   echo -ne "\t\t\tprevious step) or 'rep_seqs.fasta'.\n"
   echo
   echo -ne "\t--qtable\tPath to query sequence abundance table. It should be 'rep_table.qza'. This argument is only needed if \n"
   echo -ne "\t\t\tdata was imported into QIIME2 at the previous step.\n"
   echo
   echo -ne "\t--db\t\tPath to the name of the reference database used by blastn to carry out the taxonomic analysis. \n"
   echo -ne "\t\t\tThe rEGEN-B (rrn operons Extracted from GENomes of Bacteria) database as well as the GROND, Silva138 and Greengenes2 databases \n"
   echo -ne "\t\t\tare also available in the PRONAME docker and are located in the folder '/opt/db'. \n"
   echo -ne "\t\t\tThe user can provide the name of another blastn database if desired. Note that the database must be formatted \n"
   echo -ne "\t\t\tto run with the BLAST Command Line Applications (for more info, see: https://www.ncbi.nlm.nih.gov/books/NBK569841/).\n"
   echo
   echo -ne "\t--reftax\tPath to the taxonomic lineages of the sequences included in the reference database. \n"
   echo -ne "\t\t\tThe taxonomy tsv files associated with the rEGEN-B, GROND, Silva138 and Greengenes2 databases \n"
   echo -ne "\t\t\tare available in the PRONAME docker and are located in the folder '/opt/db'.\n"
   echo -ne "\t\t\tThe user can provide another reference database and associated taxonomic lineages if desired.\n"
   echo
   echo -ne "\t--evalue\tExpectation value (E) threshold to keep hits. [Default: 0.001]\n"
   echo
   echo -ne "\t--percid\tPercent identity threshold between query and subject sequences to keep hits. [Default: 80]\n"
   echo
   echo -ne "\t--qcover\tPercent query coverage threshold to keep hits. Note that this option does not correspond to the \n"
   echo -ne "\t\t\tblastn -qcov_hsp_perc option. Here, --qcover reflects the percent coverage of the whole query sequence, \n"
   echo -ne "\t\t\tso that the results provided are more consistant with those obtained with the online BLASTn tool. [Default: 80]\n"
   echo
   echo -ne "\t--threads\tNumber of threads to use for the blastn analysis. You can know the number of available threads on your \n"
   echo -ne "\t\t\tcomputer by running the command 'nproc --all' [Default: 2]\n"
   echo
   echo -ne "\t--metadata\tPath to the metadata file. It should be 'sample_metada.tsv'. This argument is only required if data was \n"
   echo -ne "\t\t\timported into QIIME2 at the previous step.\n"
   echo
   echo -ne "\t--assay\t\tName of your metabarcoding assay, that will appear in the name of taxonomy files produced.\n"
   echo
   echo -ne "\t--phyloseq\tSpecify if a phyloseq object must be generated. [Options: \"yes\" or \"no\", Default: \"no\"]\n"
   echo
   echo -ne "\t--version\tPrint the version of the pipeline.\n"
   echo
   echo -ne "\t--verbose\tActivate verbose/debug mode (no redirections).\n"
   echo
   echo -ne "\t--help\t\tPrint this help."
   echo


## Usage example
   echo -ne "\nUsage example:"
   echo -ne "\n-------------"
   echo
   echo "proname_taxonomy \\"
   echo "  --qseqs rep_seqs.qza \\"
   echo "  --qtable rep_table.qza \\"
   echo "  --db /opt/db/rEGEN-B/rEGEN-B_sequences.fasta \\"
   echo "  --reftax /opt/db/rEGEN-B/rEGEN-B_taxonomy.tsv \\"
   echo "  --metadata sample_metadata.tsv \\"
   echo "  --assay assay1 \\"
   echo "  --phyloseq yes"
   echo
}

Version()
{
    echo -ne "proname_taxonomy from the PRONAME pipeline, version 2.1.0\n\n"
}

evalue="0.001"
perc_identity="80"
query_cover="80"
num_threads="2"
generate_phyloseq="no"
verbose=false

# Transform long options to short ones

for arg in "$@"; do
  shift
  case "$arg" in
    '--help')     set -- "$@" '-h'   ;;
    '--version')  set -- "$@" '-v'   ;;
    '--qseqs')    set -- "$@" '-a'   ;;
    '--qtable')   set -- "$@" '-b'   ;;
    '--db')       set -- "$@" '-c'   ;;
    '--reftax')   set -- "$@" '-d'   ;;
    '--evalue')   set -- "$@" '-e'   ;;
    '--percid')   set -- "$@" '-f'   ;;
    '--qcover')   set -- "$@" '-g'   ;;
    '--threads')  set -- "$@" '-i'   ;;
    '--metadata') set -- "$@" '-j'   ;;
    '--assay')    set -- "$@" '-k'   ;;
    '--phyloseq') set -- "$@" '-p'   ;;
    '--verbose')  verbose=true ;;
    *)            set -- "$@" "$arg" ;;
  esac
done


# Parse short options

while getopts :hva:b:c:d:e:f:g:h:i:j:k:p: flag
do
    case "${flag}" in
        h) Help
        exit;;
        v) Version
        exit;;
        a) query_seqs=${OPTARG};;
        b) query_table=${OPTARG};;
        c) db=${OPTARG};;
        d) ref_taxonomy=${OPTARG};;
        e) evalue=${OPTARG};;
        f) perc_identity=${OPTARG};;
        g) query_cover=${OPTARG};;
        i) num_threads=${OPTARG};;
        j) metadata=${OPTARG};;
        k) assay_name=${OPTARG};;
        p) generate_phyloseq=${OPTARG};;
        \?) # Invalid option
                echo -ne "Error: Invalid option \n"
                echo -ne "Please consult the help menu with 'proname_taxonomy --help'\n"
                exit;;
    esac
done


# Mandatory arguments

if [ ! "$query_seqs" ] || [ ! "$db" ] || [ ! "$ref_taxonomy" ] || [ ! "$assay_name" ]; then
  echo -ne "\n\033[31m\033[1mError: arguments --qseqs, --db, --reftax and --assay must be provided\033[0m\n\n"
  echo -ne "Please consult the help menu with 'proname_taxonomy --help'\n"
  exit;
fi


# Define exec_cmd function for conditional verbosity
exec_cmd() {
  if $verbose; then
    eval "$@"
  else
    eval "$@" >/dev/null 2>&1
  fi
}


###########################################



if [ -f "rep_seqs.qza" ]
then
   if [ ! "$query_table" ] || [ ! "$metadata" ]
   then
      echo -ne "\n\033[31m\033[1mError: arguments --qtable and --metadata must also be provided if running the taxonomic analysis on QIIME2 files (qza).\033[0m\n\n"
      echo -ne "Please consult the help menu with 'proname_taxonomy --help'\n"
   exit;
   fi

   echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;38;5;39mCarrying out the taxonomic analysis...\033[0m\n"

   ARCH=$(uname -m)

   if [[ "$ARCH" == "x86_64" ]]
   then
      exec_cmd "qiime tools export \
        --input-path ${query_seqs} \
        --output-path ."
   elif [[ "$ARCH" == "aarch64" ]]
   then
      echo -ne "\033[1;33mARM64 users: Be aware that, for practical reasons, 'rep_seqs.fasta' is used for the taxonomic analysis, even if you supplied 'rep_seqs.qza' via the --qseqs argument.\033[0m \n"
      cp rep_seqs.fasta dna-sequences.fasta
   else
      echo -ne "\n\033[31m\033[1mError: Unknown system architecture '$ARCH'. Unable to decide QIIME2 strategy.\033[0m\n"
      exit 1
   fi

   blastn \
     -query dna-sequences.fasta \
     -db ${db} \
     -num_threads ${num_threads} \
     -max_target_seqs 15 \
     -evalue ${evalue} \
     -perc_identity ${perc_identity} \
     -outfmt "6 qacc saccver qcovs" \
     -out blastn_outfile.tsv

   # Removing matches below the query_cover threshold

   awk -v qcov="$query_cover" 'BEGIN {FS=OFS="\t"} $3>=qcov {print $1,$2}' blastn_outfile.tsv > blastn_outfile.tsv_tmp && mv blastn_outfile.tsv_tmp blastn_outfile.tsv

   # Recording the top 1 match

   awk -F'\t' '{occurrences[$1]++; if (occurrences[$1] <= 1) {print;}}' blastn_outfile.tsv > blastn_outfile.tsv_tmp && mv blastn_outfile.tsv_tmp blastn_outfile.tsv

   # Merging blastn match accession number with corresponding taxonomic lineage

   LC_ALL=C join -t $'\t' -1 2 -2 1 -a 1 \
         <(LC_ALL=C sort -t $'\t' -k 2 blastn_outfile.tsv)\
         <(LC_ALL=C sort -t $'\t' -k 1 ${ref_taxonomy}) | awk 'BEGIN {FS=OFS="\t"} {print $2,$3}' > taxonomy_blastn.tsv


   # Adding an Unassigned label for seqs without match

   cat <(grep ">" dna-sequences.fasta | cut -d '>' -f 2 | cut -d ' ' -f 1) <(cut -d $'\t' -f 1 blastn_outfile.tsv) | sort | uniq -u > Unassigned_seqids

   cat taxonomy_blastn.tsv Unassigned_seqids | awk 'BEGIN {FS=OFS="\t"} {if ($2=="") $2="Unassigned"; print}' > taxonomy_blastn.tsv_tmp
   mv taxonomy_blastn.tsv_tmp taxonomy_${assay_name}_blastn.tsv
   rm taxonomy_blastn.tsv
   rm Unassigned_seqids
   rm dna-sequences.fasta
   rm -r Rawseqids >/dev/null 2>/dev/null
   rm blastn_outfile.tsv

   
   if [ -e "taxonomy_${assay_name}_blastn.tsv" ]
   then
      echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;32mTaxonomic analysis completed! \033[0m\n"
   else
      echo -ne "\n\033[31m\033[1mError: taxonomic analysis failed. \033[0m\n\n"
      echo -ne "Please consult the help menu.\n"
      exit;
   fi

   # If the user requested to generate a phyloseq object
   if [ "$generate_phyloseq" = "yes" ]
   then
      echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;38;5;39mGenerating phyloseq object...\033[0m\n"
      awk -F'\t' '{gsub(/;/, "", $1); print}' OFS='\t' taxonomy_${assay_name}_blastn.tsv > taxonomy_${assay_name}_blastn_for_nwk.tsv
      sed 's/;//g' rep_seqs.fasta > rep_seqs_for_nwk.fasta
      awk 'NR==1 {print} NR>1 {gsub(/;/, ""); print}' rep_table.tsv > rep_table_for_nwk.tsv

      exec_cmd "mafft --auto rep_seqs_for_nwk.fasta > aligned_seqs.fasta"
      exec_cmd "fasttree -nt aligned_seqs.fasta > phy_tree.nwk"
      exec_cmd "Rscript /opt/scripts/generate_phyloseq.R rep_table_for_nwk.tsv taxonomy_${assay_name}_blastn_for_nwk.tsv rep_seqs_for_nwk.fasta phy_tree.nwk"
      rm phy_tree.nwk
      rm aligned_seqs.fasta
      rm *for_nwk*

      if [ -e "phyloseq_object.rds" ]
      then
         echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;32mPhyloseq object created successfully! \033[0m\n"
         echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : You can use the generated object (\e[34mphyloseq_object.rds\e[0m) to perform further analyses using R.\n"
      else
         echo -ne "\n\033[31m\033[1mError: Phyloseq object creation failed. \033[0m\n\n"
         echo -ne "Please consult the help menu.\n"
         exit;
      fi
   fi

   echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;38;5;39mImporting taxonomy files into QIIME2...\033[0m\n"

   if [[ "$ARCH" == "x86_64" ]]
   then
      exec_cmd "qiime tools import \
        --type 'FeatureData[Taxonomy]' \
        --input-format HeaderlessTSVTaxonomyFormat \
        --input-path taxonomy_${assay_name}_blastn.tsv \
        --output-path taxonomy_blastn.qza"

      if [ -e "taxonomy_blastn.qza" ]
      then
         echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;32mThe taxonomy file was successfully imported into QIIME2! \033[0m\n"
         echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;38;5;39mCreating a taxa barplot...\033[0m\n"
      else
         echo -ne "\n\033[31m\033[1mError: importing taxonomy file into QIIME2 failed. \033[0m\n\n"
         echo -ne "Please consult the help menu.\n"
         exit;
      fi

      exec_cmd "qiime taxa barplot \
        --i-table ${query_table} \
        --i-taxonomy taxonomy_blastn.qza \
        --m-metadata-file ${metadata} \
        --o-visualization taxa_barplot_${assay_name}_blastn.qzv"

      if [ -e "taxa_barplot_${assay_name}_blastn.qzv" ]
      then
         echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;32mTaxa barplot created! \033[0m\n"
         echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : You can now inspect the taxa barplot (\e[34mtaxa_barplot_${assay_name}_blastn.qzv\e[0m) on \033[4mhttps://view.qiime2.org/\033[0m.\n"
         echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : You can also use the generated taxonomy file (\e[34mtaxonomy_blastn.qza\e[0m), the representative sequences (\e[34mrep_seqs.qza\e[0m) and their frequency in each sample (\e[34mrep_table.qza\e[0m) for further processing with QIIME2 like alpha-/beta-diversity analysis or differential abundance testing, among others.\n"
      else
         echo -ne "\n\033[31m\033[1mError: the taxa barplot creation failed. \033[0m\n\n"
         echo -ne "Please consult the help menu.\n"
         exit;
      fi

   elif [[ "$ARCH" == "aarch64" ]]
   then
      echo -ne "\n\033[1;33m!!! NOTE FOR ARM64 USERS !!!\033[0m\n"
      echo -ne "The current Docker image runs on ARM64 architecture, and QIIME2 is not natively supported on ARM64.\n\n"
      echo -ne "\e[4mYou have two options\e[0m:\n\n"
      echo -ne "(i) If QIIME2 is installed on your host machine, run the following commands manually on it:\n\n"
      echo -ne "\033[1m# Defining variables: Re-enter here the values you provided for the --qtable, --metadata and --assay arguments when running proname_taxonomy\033[0m\n"
      echo -ne "query_table=\"rep_table.qza\" \n"
      echo -ne "metadata=\"sample_metadata.tsv\" \n"
      echo -ne "assay_name=\"assay1\" \n"
      echo
      echo -ne "\033[1m# Importing taxonomy into QIIME2\033[0m\n"
      echo -ne "qiime tools import --input-path taxonomy_\${assay_name}_blastn.tsv --type 'FeatureData[Taxonomy]' --input-format HeaderlessTSVTaxonomyFormat --output-path taxonomy_blastn.qza\n\n"
      echo -ne "\033[1m# Creating taxa barplot in QIIME2\033[0m\n"
      echo -ne "qiime taxa barplot --i-table \${query_table} --i-taxonomy taxonomy_blastn.qza --m-metadata-file \${metadata} --o-visualization taxa_barplot_\${assay_name}_blastn.qzv\n\n"
      echo
      echo -ne "(ii) If QIIME2 is not installed on your host machine, run the following commands manually on it:\n\n"
      echo -ne "\033[1m# Defining variables: Re-enter here the values you provided for the --qtable, --metadata and --assay arguments when running proname_taxonomy\033[0m\n"
      echo -ne "query_table=\"rep_table.qza\" \n"
      echo -ne "metadata=\"sample_metadata.tsv\" \n"
      echo -ne "assay_name=\"assay1\" \n"
      echo
      echo -ne "\033[1m# Importing taxonomy into QIIME2\033[0m\n"
      echo -ne "docker run --rm -v /path/to/host/data:/data quay.io/qiime2/core:2024.5 qiime tools import \\ \n"
      echo -ne "  --input-path taxonomy_\${assay_name}_blastn.tsv \\ \n"
      echo -ne "  --type 'FeatureData[Taxonomy]' \\ \n"
      echo -ne "  --input-format HeaderlessTSVTaxonomyFormat \\ \n"
      echo -ne "  --output-path taxonomy_blastn.qza \n"
      echo
      echo -ne "\033[1m# Creating taxa barplot in QIIME2\033[0m\n"
      echo -ne "docker run --rm -v /path/to/host/data:/data quay.io/qiime2/core:2024.5 qiime taxa barplot \\ \n"
      echo -ne "  --i-table \${query_table} \\ \n"
      echo -ne "  --i-taxonomy taxonomy_blastn.qza \\ \n"
      echo -ne "  --m-metadata-file \${metadata} \\ \n"
      echo -ne "  --o-visualization taxa_barplot_\${assay_name}_blastn.qzv \n\n"

      echo -ne "\033[1;33mOnce these files are ready, you will be able to inspect the taxa barplot (\033[34mtaxa_barplot_\${assay_name}_blastn.qzv\033[1;33m) on \033[4;1;33mhttps://view.qiime2.org/\033[1;33m).\033[0m\n"
      echo -ne "\033[1;33mYou will also be able to use the generated taxonomy file (\033[34mtaxonomy_blastn.qza\033[1;33m), the representative sequences (\033[34mrep_seqs.qza\033[1;33m) and their frequency in each sample (\033[34mrep_table.qza\033[1;33m) for further processing with QIIME2 like alpha-/beta-diversity analysis or differential abundance testing, among others.\033[0m\n"

   else
      echo -ne "\n\033[31m\033[1mError: Unknown system architecture '$ARCH'. Unable to decide QIIME2 strategy.\033[0m\n"
      exit 1
   fi

else
   echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;38;5;39mCarrying out the taxonomic analysis...\033[0m\n"

   blastn \
     -query ${query_seqs} \
     -db ${db} \
     -num_threads ${num_threads} \
     -max_target_seqs 15 \
     -evalue ${evalue} \
     -perc_identity ${perc_identity} \
     -outfmt "6 qacc saccver qcovs" \
     -out blastn_outfile.tsv

   # Removing matches below the query_cover threshold

   awk -v qcov="$query_cover" 'BEGIN {FS=OFS="\t"} $3>=qcov {print $1,$2}' blastn_outfile.tsv > blastn_outfile.tsv_tmp && mv blastn_outfile.tsv_tmp blastn_outfile.tsv


   # Merging blastn match accession number with corresponding taxonomic lineage

   join -t $'\t' -1 2 -2 1 -a 1 \
         <(sort -t $'\t' -k 2 blastn_outfile.tsv)\
         <(sort -t $'\t' -k 1 ${ref_taxonomy}) | awk 'BEGIN {FS=OFS="\t"} {print $2,$3}' > taxonomy_blastn.tsv


   # Adding an Unassigned label for seqs without match

   cat <(grep ">" dna-sequences.fasta | cut -d '>' -f 2 | cut -d ' ' -f 1) <(cut -d $'\t' -f 1 blastn_outfile.tsv) | sort | uniq -u > Unassigned_seqids

   cat taxonomy_blastn.tsv Unassigned_seqids | awk 'BEGIN {FS=OFS="\t"} {if ($2=="") $2="Unassigned"; print}' > taxonomy_${assay_name}_blastn.tsv

   if [ -e "taxonomy_${assay_name}_blastn.tsv" ]
   then
      echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;32mTaxonomic analysis completed! \033[0m\n"
   else
      echo -ne "\n\033[31m\033[1mError: the taxonomic analysis failed. \033[0m\n\n"
      echo -ne "Please consult the help menu.\n"
      exit;
   fi

   # If the user requested to generate a phyloseq object
   if [ "$generate_phyloseq" = "yes" ]
   then
      echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;38;5;39mGenerating phyloseq object...\033[0m\n"
      awk -F'\t' '{gsub(/;/, "", $1); print}' OFS='\t' taxonomy_${assay_name}_blastn.tsv > taxonomy_${assay_name}_blastn_for_nwk.tsv
      sed 's/;//g' rep_seqs.fasta > rep_seqs_for_nwk.fasta
      awk 'NR==1 {print} NR>1 {gsub(/;/, ""); print}' rep_table.tsv > rep_table_for_nwk.tsv

      exec_cmd "mafft --auto rep_seqs_for_nwk.fasta > aligned_seqs.fasta"
      exec_cmd "fasttree -nt aligned_seqs.fasta > phy_tree.nwk"
      exec_cmd "Rscript /opt/scripts/generate_phyloseq.R rep_table_for_nwk.tsv taxonomy_${assay_name}_blastn_for_nwk.tsv rep_seqs_for_nwk.fasta phy_tree.nwk"
      rm phy_tree.nwk
      rm aligned_seqs.fasta
      rm *for_nwk*

      if [ -e "phyloseq_object.rds" ]
      then
         echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : \033[1;32mPhyloseq object created successfully! \033[0m\n"
         echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : You can now use the generated taxonomy file (\e[34mtaxonomy_${assay_name}_blastn.tsv\e[0m), the representative sequences (\e[34mrep_seqs.fasta\e[0m), their frequency in each sample (\e[34mrep_table.tsv\e[0m) and/or the associated phyloseq object (\e[34mphyloseq_object.rds\e[0m) for further processing outside of QIIME2."
      else
         echo -ne "\n\033[31m\033[1mError: Phyloseq object creation failed. \033[0m\n\n"
         echo -ne "Please consult the help menu.\n"
         exit;
      fi
   else
      echo -ne "[$(date +'%Y-%m-%d || %H:%M:%S')] : You can now use the generated taxonomy file (\e[34mtaxonomy_${assay_name}_blastn.tsv\e[0m) together with the representative sequences (\e[34mrep_seqs.fasta\e[0m) and their frequency in each sample (\e[34mrep_table.tsv\e[0m) for further processing outside of QIIME2."
   fi
   rm Unassigned_seqids
   rm taxonomy_blastn.tsv
   rm -r Rawseqids >/dev/null 2>/dev/null
   rm blastn_outfile.tsv

fi


unset query_seqs
unset query_table
unset db
unset ref_taxonomy
unset evalue
unset perc_identity
unset query_cover
unset num_threads
unset metadata
unset assay_name
unset generate_phyloseq
unset ARCH
unset verbose

